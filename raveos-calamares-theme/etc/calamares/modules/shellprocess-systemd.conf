script:
  - name: install-cachyos-kernel-install-hook
    description: "Install systemd-boot kernel-install hook for linux-cachyos"
    timeout: 0
    command: |
      TARGET=/mnt

      # Ensure kernel-install directory exists in target
      mkdir -p "$TARGET/usr/lib/kernel/install.d"

      # Install CachyOS kernel-install hook
      cp /usr/share/calamares/kernel-install/90-linux-cachyos.install \
         "$TARGET/usr/lib/kernel/install.d/90-linux-cachyos.install"

      chmod 0755 "$TARGET/usr/lib/kernel/install.d/90-linux-cachyos.install"

      # OPTIONAL: regenerate loader entry once (safe)
      if [ -x "$TARGET/usr/bin/kernel-install" ]; then
          chroot "$TARGET" kernel-install add linux-cachyos /boot/vmlinuz-linux-cachyos || true
      fi

